<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StyleGAN3 Progressive Mixing</title>
    <style>
        /* (기존 스타일 동일 – 생략 가능) */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎨 StyleGAN3 Progressive Mixing</h1>
            <p>기린과 사람 얼굴 이미지를 업로드하고 점진적 혼합을 체험해보세요</p>
        </div>

        <!-- 업로드 섹션 -->
        <div class="upload-section">
            <div class="upload-grid">
                <div class="upload-area" id="giraffeUpload" onclick="document.getElementById('giraffeFile').click()">
                    <div class="upload-icon">🦒</div>
                    <div class="upload-text">기린 이미지 업로드</div>
                    <div class="upload-hint">.jpg 또는 .png 파일</div>
                    <button class="upload-button">파일 선택</button>
                    <div class="uploaded-info" id="giraffeInfo"></div>
                    <input type="file" id="giraffeFile" class="file-input" accept=".jpg,.png" onchange="handleFileUpload(this, 'giraffe')">
                </div>
                <div class="upload-area" id="humanUpload" onclick="document.getElementById('humanFile').click()">
                    <div class="upload-icon">👤</div>
                    <div class="upload-text">사람 이미지 업로드</div>
                    <div class="upload-hint">.jpg 또는 .png 파일</div>
                    <button class="upload-button">파일 선택</button>
                    <div class="uploaded-info" id="humanInfo"></div>
                    <input type="file" id="humanFile" class="file-input" accept=".jpg,.png" onchange="handleFileUpload(this, 'human')">
                </div>
            </div>
            <button class="start-button" id="startButton" onclick="startMixing()" disabled>🚀 스타일 믹싱 시작하기</button>
        </div>

        <!-- 혼합 섹션 -->
        <div class="mixing-section" id="mixingSection">
            <h2 class="section-title">점진적 스타일 혼합</h2>
            <div class="controls-panel">
                <div class="seed-controls">
                    <div class="seed-input">
                        <label>기린 시드</label>
                        <input type="number" id="giraffeSeed" value="42">
                    </div>
                    <div class="seed-input">
                        <label>사람 시드</label>
                        <input type="number" id="humanSeed" value="123">
                    </div>
                    <button class="random-button" onclick="randomizeSeeds()">🎲 랜덤</button>
                </div>
                <div class="slider-container">
                    <div class="slider-label">
                        <span class="slider-title">혼합 정도</span>
                        <span class="slider-value" id="mixingValue">0%</span>
                    </div>
                    <input type="range" id="mixingSlider" min="0" max="100" value="0" class="mixing-slider" oninput="updateMixing(this.value)">
                </div>
                <div class="play-controls">
                    <button class="play-button" id="playButton" onclick="toggleAnimation()">▶️ 애니메이션 재생</button>
                    <button class="reset-button" onclick="resetMixing()">🔄 초기화</button>
                </div>
            </div>
            <div class="result-display">
                <div class="result-image" id="resultImage">
                    <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div></div>
                    혼합된 이미지가 여기에 표시됩니다
                </div>
                <div class="result-info" id="resultInfo"></div>
                <button class="download-button" onclick="downloadImage()" id="downloadButton" style="display:none">💾 이미지 다운로드</button>
            </div>
        </div>
    </div>

<script>
let uploadedModels = { giraffe: null, human: null };
let currentMixingLevel = 0;
let isAnimating = false;
let animationInterval = null;

function handleFileUpload(input, modelType) {
    const file = input.files[0];
    if (!file) return;

    const info = document.getElementById(`${modelType}Info`);
    document.getElementById(`${modelType}Upload`).classList.add('uploaded');
    info.style.display = 'block';
    info.innerHTML = `<strong>✅ ${file.name}</strong><br>크기: ${(file.size / 1024 / 1024).toFixed(2)} MB`;

    uploadedModels[modelType] = file;
    if (uploadedModels.giraffe && uploadedModels.human) {
        document.getElementById('startButton').disabled = false;
    }
}

function startMixing() {
    document.querySelector('.upload-section').style.display = 'none';
    document.getElementById('mixingSection').classList.add('active');
    generateMixedImage(0);
}

function updateMixing(value) {
    currentMixingLevel = parseInt(value);
    document.getElementById('mixingValue').textContent = `${value}%`;
    updateResultInfo(currentMixingLevel);
    generateMixedImage(currentMixingLevel);
}

function updateResultInfo(level) {
    const info = document.getElementById('resultInfo');
    info.textContent = level === 0 ? '100% 기린' : level === 100 ? '100% 사람' : `혼합 정도: ${level}%`;
}

function randomizeSeeds() {
    document.getElementById('giraffeSeed').value = Math.floor(Math.random() * 999999);
    document.getElementById('humanSeed').value = Math.floor(Math.random() * 999999);
    generateMixedImage(currentMixingLevel);
}

function generateMixedImage(mixLevel) {
    const overlay = document.getElementById('loadingOverlay');
    overlay.classList.add('active');

    const formData = new FormData();
    formData.append('giraffe', uploadedModels.giraffe);
    formData.append('human', uploadedModels.human);
    formData.append('mixing_level', mixLevel);
    formData.append('giraffe_seed', document.getElementById('giraffeSeed').value);
    formData.append('human_seed', document.getElementById('humanSeed').value);

    fetch('http://localhost:8000/mix', {
        method: 'POST',
        body: formData
    }).then(res => res.blob())
      .then(blob => {
        const url = URL.createObjectURL(blob);
        document.getElementById('resultImage').innerHTML = `<img src="${url}" alt="결과">`;
        overlay.classList.remove('active');
        document.getElementById('downloadButton').style.display = 'inline-block';
    }).catch(() => {
        overlay.classList.remove('active');
        document.getElementById('resultImage').textContent = "이미지를 불러오는 데 실패했습니다.";
    });
}

function toggleAnimation() {
    const btn = document.getElementById('playButton');
    if (isAnimating) {
        clearInterval(animationInterval);
        btn.innerHTML = '▶️ 애니메이션 재생';
        isAnimating = false;
    } else {
        isAnimating = true;
        btn.innerHTML = '⏸️ 일시정지';
        let dir = 1;
        animationInterval = setInterval(() => {
            currentMixingLevel += dir * 2;
            if (currentMixingLevel >= 100 || currentMixingLevel <= 0) dir *= -1;
            document.getElementById('mixingSlider').value = currentMixingLevel;
            updateMixing(currentMixingLevel);
        }, 200);
    }
}

function resetMixing() {
    if (isAnimating) toggleAnimation();
    currentMixingLevel = 0;
    document.getElementById('mixingSlider').value = 0;
    updateMixing(0);
}

function downloadImage() {
    const img = document.querySelector('#resultImage img');
    if (img) {
        const a = document.createElement('a');
        a.href = img.src;
        a.download = `mix_${currentMixingLevel}.png`;
        a.click();
    }
}
</script>
</body>
</html>
